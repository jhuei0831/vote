package graph

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.81

import (
	"context"
	"vote/app/database"
	"vote/app/model"
	"vote/app/service"
	"vote/app/utils"
	graph "vote/graph/generated"

	"github.com/google/uuid"
	"github.com/vektah/gqlparser/v2/gqlerror"
)

// CreateVote is the resolver for the createVote field.
func (r *mutationResolver) CreateVote(ctx context.Context, input model.VoteCreate) (*model.Vote, error) {
	gc, err := utils.GinContextFromContext(ctx)
	if err != nil {
		return nil, err
	}

	userId, exists := gc.Get("id")
	if !exists {
		return nil, gqlerror.Errorf("user not exists")
	}

	input.UserID = userId.(uint64)

	vote, err := service.NewVoteService().CreateVote(input)
	if err != nil {
		return nil, gqlerror.Errorf("failed to create vote: %v", err)
	}

	return vote, nil
}

// UpdateVote is the resolver for the updateVote field.
func (r *mutationResolver) UpdateVote(ctx context.Context, uuid uuid.UUID, input model.VoteUpdate) (*model.Vote, error) {
	vote, err := service.NewVoteService().UpdateVote(uuid, input)
	if err != nil {
		return nil, gqlerror.Errorf("failed to create vote: %v", err)
	}

	return vote, nil
}

// DeleteVote is the resolver for the deleteVote field.
func (r *mutationResolver) DeleteVote(ctx context.Context, uuids []uuid.UUID) ([]*model.Vote, error) {
	gc, err := utils.GinContextFromContext(ctx)
	if err != nil {
		return nil, err
	}

	userId, exists := gc.Get("id")
	if !exists {
		return nil, gqlerror.Errorf("user not exists")
	}

	isAdmin, err := database.CheckIfAdmin(userId.(uint64))
	if err != nil {
		return nil, gqlerror.Errorf("failed to check user role")
	}

	votes, err := service.NewVoteService().DeleteVote(uuids, isAdmin, userId.(uint64))
	if err != nil {
		return nil, gqlerror.Errorf("failed to delete votes: %v", err)
	}

	return votes, nil
}

// Votes is the resolver for the votes field.
func (r *queryResolver) Votes(ctx context.Context, input *model.VoteQuery) ([]*model.VoteConnection, error) {
	gc, err := utils.GinContextFromContext(ctx)
	if err != nil {
		return nil, err
	}

	userId, exists := gc.Get("id")
	if !exists {
		return nil, gqlerror.Errorf("user not exists")
	}

	isAdmin, err := database.CheckIfAdmin(userId.(uint64))
	if err != nil {
		return nil, gqlerror.Errorf("failed to check user role")
	}

	votes, err := service.NewVoteService().SelectAllVotes(isAdmin, userId.(uint64), input)

	return votes, err
}

// Creator is the resolver for the creator field.
func (r *voteResolver) Creator(ctx context.Context, obj *model.Vote) (*model.User, error) {
	user, err := service.NewUserService().GetUserById(int64(obj.UserID))

	return user, err
}

// Vote returns graph.VoteResolver implementation.
func (r *Resolver) Vote() graph.VoteResolver { return &voteResolver{r} }

type voteResolver struct{ *Resolver }
